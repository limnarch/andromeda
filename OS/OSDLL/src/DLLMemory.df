//
// Implements memory query dumping.
//

#include "<df>/dragonfruit.h"

#include "<inc>/OSCalls.h"
#include "<inc>/OSMap.h"
#include "<inc>/OSAccess.h"
#include "<inc>/OSAbort.h"
#include "<inc>/OSObject.h"
#include "<inc>/OSStatus.h"
#include "<inc>/OSProcess.h"
#include "<inc>/OSFile.h"
#include "<inc>/OSSignal.h"
#include "<inc>/OSMemory.h"

#include "OSDLL.h"

fn OSMemoryInformationDump { query -- }
	query@ OSMemoryInformation_FileCachePageCount + @
	"  File cache pages: %9d " Printf

	auto evictables
	query@ OSMemoryInformation_EvictableFastPageCount + @
	query@ OSMemoryInformation_EvictableSlowPageCount + @ + evictables!

	auto pagesused
	query@ OSMemoryInformation_PageTotalCount + @
	query@ OSMemoryInformation_PageFreeCount + @ - pagesused!

	query@ OSMemoryInformation_PageTotalCount + @ OSPAGESHIFT << 1024 /
	pagesused@ evictables@ - OSPAGESHIFT << 1024 /
	"Memory usage:     %dKB / %dKB\n" Printf

	query@ OSMemoryInformation_AnonymousPageCount + @
	"  Anonymous pages:  %9d " Printf

	query@ OSMemoryInformation_SwapPagePeakCount + @ OSPAGESHIFT << 1024 /
	query@ OSMemoryInformation_SwapPageTotalCount + @ OSPAGESHIFT << 1024 /
	query@ OSMemoryInformation_SwapPageUsedCount + @ OSPAGESHIFT << 1024 /
	"Swapfile usage:   %dKB / %dKB (%dKB peak)\n" Printf

	query@ OSMemoryInformation_ModifiedPageCount + @
	"  Modified pages:   %9d " Printf

	query@ OSMemoryInformation_WorkingSetPagePeakCount + @ OSPAGESHIFT << 1024 /
	query@ OSMemoryInformation_WorkingSetPageTotalCount + @ OSPAGESHIFT << 1024 /
	"Working set size: %dKB (%dKB peak)\n" Printf

	query@ OSMemoryInformation_PageFaultCount + @
	"  Page faults:      %9d " Printf

	query@ OSMemoryInformation_PoolBytesUsedExternally + @ 1024 /
	query@ OSMemoryInformation_PoolBytesUsedInternally + @ 1024 /
	"Pool usage:       %dKB (%dKB in memory)\n" Printf

	query@ OSMemoryInformation_SwapPagesRead + @
	"  Swap IO (read):   %9d " Printf

	query@ OSMemoryInformation_SwapPagesWritten + @
	"Swap IO (write):  %9d\n" Printf

	if (0)
		query@ OSMemoryInformation_CommitLimit + @
		query@ OSMemoryInformation_CommitUsage + @
		"  Commit usage:     %d / %d\n" Printf
	end

	if (0)
		query@ OSMemoryInformation_EvictableSlowPageCount + @
		query@ OSMemoryInformation_EvictableFastPageCount + @
		"  Evictable pages:  %d fast, %d slow\n" Printf
	end
end