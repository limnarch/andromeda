//
// Implements the module management APIs.
//

#include "<df>/dragonfruit.h"

#include "<inc>/OSCalls.h"
#include "<inc>/OSMap.h"
#include "<inc>/OSFile.h"
#include "<inc>/OSAbort.h"
#include "<inc>/OSAccess.h"
#include "<inc>/OSObject.h"
#include "<inc>/OSStatus.h"
#include "<inc>/OSModule.h"
#include "<inc>/OSAlloc.h"
#include "<inc>/OSWait.h"
#include "<inc>/OSFastMutex.h"

#include "OSDLL.h"

fn OSGetSymbolAddress { name dll -- address ok }
	DLLModuleMutex OSFastMutexAcquire

	name@ dll@ ComDLLGetSymbolAddress ok! address!

	DLLModuleMutex OSFastMutexRelease
end

fn OSModuleLoad { flags name -- dll ok }
	DLLModuleMutex OSFastMutexAcquire

	flags@ name@ ComDLLLoad ok! dll!

	DLLModuleMutex OSFastMutexRelease
end

fn OSModuleUnload { dll -- }
	DLLModuleMutex OSFastMutexAcquire

	dll@ ComDLLUnload

	DLLModuleMutex OSFastMutexRelease
end