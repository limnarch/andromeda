#include "<df>/dragonfruit.h"

#include "<ll>/OSDLL/OS.h"

buffer MemoryInformation OSMemoryInformation_SIZEOF

fn Main { ... -- ret }
	0 ret!

	MemoryInformation OSMemoryQuery ret!

	if (ret@)
		ret@ OSStatusGetName "mem: couldn't query system memory usage: %s\n" OSError
	end

	if (argc@ 2 >=)
		if ([1]argv@ "-c" strcmp)
			// Comprehensive output.

			ComprehensiveDump

			return
		end
	end

	// Print summary (OSDLL handles this).

	MemoryInformation OSMemoryInformationDump
end

fn ComprehensiveDump { -- }
	auto info
	MemoryInformation info!

	info@ OSMemoryInformation_RealPageCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_FluidPageCount + @ OSPAGESHIFT << 1024 /
	"Memory (fluid/real):         %dKB/%dKB\n" Printf

	info@ OSMemoryInformation_AvailablePageCount + @ OSPAGESHIFT << 1024 /
	"Available memory:            %dKB\n" Printf

	info@ OSMemoryInformation_FileCachePageCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_AnonymousPageCount + @ OSPAGESHIFT << 1024 /
	"Memory (anon/file):          %dKB/%dKB\n" Printf

	info@ OSMemoryInformation_SwapPagePeakCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_SwapPageTotalCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_SwapPageUsedCount + @ OSPAGESHIFT << 1024 /
	"Pagefile (used/total, peak): %dKB/%dKB, %dKB\n" Printf

	info@ OSMemoryInformation_SwapPagesWritten + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_SwapPagesRead + @ OSPAGESHIFT << 1024 /
	"Pagefile IO (read/written):  %dKB/%dKB\n" Printf

	info@ OSMemoryInformation_NonpagedPoolBytesUsedPeak + @ 1024 /
	info@ OSMemoryInformation_NonpagedPoolBytesUsedExternally + @ 1024 /
	info@ OSMemoryInformation_NonpagedPoolBytesUsedInternally + @ 1024 /
	"NP Pool (int/ext, peak):     %dKB/%dKB, %dKB\n" Printf

	info@ OSMemoryInformation_PagedPoolBytesUsedPeak + @ 1024 /
	info@ OSMemoryInformation_PagedPoolBytesUsedExternally + @ 1024 /
	info@ OSMemoryInformation_PagedPoolBytesUsedInternally + @ 1024 /
	"Pg Pool (int/ext, peak):     %dKB/%dKB, %dKB\n" Printf

	info@ OSMemoryInformation_EvictablePageCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_ZeroPageCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_FreePageCount + @ OSPAGESHIFT << 1024 /
	"Page lists (free/zero/evic): %dKB/%dKB/%dKB\n" Printf

	info@ OSMemoryInformation_ModifiedPageMaximum + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_ModifiedPageCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_ModifiedFilePageCount + @ OSPAGESHIFT << 1024 /
	"Dirty memory (file/all/max): %dKB/%dKB/%dKB\n" Printf

	info@ OSMemoryInformation_WorkingSetPagePeakCount + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_WorkingSetPageTotalCount + @ OSPAGESHIFT << 1024 /
	"Working set (cur/peak):      %dKB/%dKB\n" Printf

	info@ OSMemoryInformation_TheoreticalCommitLimit + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_CommitLimit + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_CommitUsage + @ OSPAGESHIFT << 1024 /
	"Commit (usage/avail/max):    %dKB/%dKB/%dKB\n" Printf

	info@ OSMemoryInformation_PhysicalCommitLimit + @ OSPAGESHIFT << 1024 /
	info@ OSMemoryInformation_PhysicalCommitUsage + @ OSPAGESHIFT << 1024 /
	"Physical commit (cur/max):   %dKB/%dKB\n" Printf

	info@ OSMemoryInformation_ViewCachePageCount + @ OSPAGESHIFT << 1024 /
	"Resident viewcache:          %dKB\n" Printf

	info@ OSMemoryInformation_PageFaultCount + @
	info@ OSMemoryInformation_HardPageFaultCount + @
	info@ OSMemoryInformation_SoftPageFaultCount + @
	"Page faults (soft/hard/all): %d/%d/%d\n" Printf

	info@ OSMemoryInformation_PageInCount + @
	"Page-in count:               %d\n" Printf

	info@ OSMemoryInformation_DirtyFileCount + @
	"Dirty files:                 %d\n" Printf
end